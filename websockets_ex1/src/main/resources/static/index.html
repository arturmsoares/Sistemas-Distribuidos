<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chat STOMP</title>
    <style>
      body {
        font-family: system-ui, Arial;
        max-width: 800px;
        margin: 2rem auto;
      }

      .row {
        display: flex;
        gap: 0.5rem;
        margin: 0.5rem 0;
      }

      input,
      button {
        padding: 0.5rem;
      }

      .chat-container {
        display: flex;
        gap: 1rem;
      }

      #log {
        border: 1px solid #ddd;
        padding: 1rem;
        height: 320px;
        overflow: auto;
        flex: 3;
      }

      #user-list-container {
        flex: 1;
        border: 1px solid #ddd;
        padding: 1rem;
        height: 320px;
        overflow: auto;
      }
      #user-list-container h3 {
        margin: 0 0 1rem 0;
      }
      #user-list div {
        padding: 2px 0;
      }

      small {
        color: #666;
      }
    </style>
  </head>

  <body>
    <h2>Chat em tempo real (Spring + STOMP)</h2>
    <div class="row">
      <input id="username" placeholder="Seu nome" />
      <button id="connectBtn">Conectar</button>
      <button id="disconnectBtn" disabled>Desconectar</button>
    </div>

    <div class="row">
      <input id="message" placeholder="Mensagem pública" />
      <button id="sendPublicBtn" disabled>Enviar público</button>
    </div>

    <div class="row">
      <select id="user-select" style="flex: 1;">
        <option value="">-- Enviar DM para --</option>
      </select>
      <input id="private-message" placeholder="Mensagem privada" style="flex: 2;" />
      <button id="sendPrivateBtn" disabled>Enviar privado</button>
    </div>

    <div class="chat-container">
      <div id="log"></div>
      <div id="user-list-container">
        <h3>Online</h3>
        <div id="user-list"></div>
      </div>
    </div>

    <!-- Importar a biblioteca STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
      let stomp = null;
      let connected = false;

      const log = (m) => {
        const el = document.getElementById("log");
        const p = document.createElement("div");
        p.innerHTML = m;
        el.appendChild(p);
        el.scrollTop = el.scrollHeight;
      };

      // atualiza o DOM com a lista de usuários
      const updateOnlineUsers = (users) => {
        const userListEl = document.getElementById("user-list");
        const userSelectEl = document.getElementById("user-select");
        
        userListEl.innerHTML = ""; 
        
        // salvando o usuário que estava selecionado no select
        const selectedUser = userSelectEl.value;
        // limpando o select
        userSelectEl.innerHTML = '<option value="">-- Enviar DM para --</option>';

        users.sort();
        
        const currentUser = document.getElementById("username").value.trim();

        users.forEach(user => {
            
            const userEl = document.createElement("div");
            userEl.textContent = user;
            userListEl.appendChild(userEl);

            // atualizando o select
            if (user !== currentUser) {
                const optionEl = document.createElement("option");
                optionEl.value = user;
                optionEl.textContent = user;
                userSelectEl.appendChild(optionEl);
            }
        });

        
        userSelectEl.value = selectedUser;
      };

      function connect() {
        const user = document.getElementById("username").value.trim();
        if (!user) {
          alert("Informe seu nome");
          return;
        }

        const wsUrl = "ws://localhost:8080/ws";
        const ws = new WebSocket(wsUrl);
        stomp = Stomp.over(ws);

        stomp.connect(
          {},
          () => {
            connected = true;
            document.getElementById("connectBtn").disabled = true;
            document.getElementById("disconnectBtn").disabled = false;
            document.getElementById("sendPublicBtn").disabled = false;
            document.getElementById("sendPrivateBtn").disabled = false;

            stomp.subscribe("/topic/public", (frame) => {
              const msg = JSON.parse(frame.body);
              log(
                `<b>[${msg.tipoMensagem}]</b> ${msg.origem ?? ""}: ${
                  msg.texto
                } <small>${msg.dataHora}</small>`
              );
            });

            // listener para a lista de usuários online
            stomp.subscribe("/topic/online", (frame) => {
              const users = JSON.parse(frame.body);
              updateOnlineUsers(users);
            });


            const myPrivateTopic = `/topic/dm.${user}`;
            stomp.subscribe(myPrivateTopic, (frame) => {
                const msg = JSON.parse(frame.body);
                // Formata a mensagem privada de forma diferente
                const from = (msg.origem === user) ? "mim" : msg.origem;
                log(
                  `<b style="color:#007bff;">[PRIVADO de ${from} para ${msg.destino}]</b>: ${
                    msg.texto
                  } <small>${msg.dataHora}</small>`
                );
            });

            stomp.send("/app/chat.join", {}, JSON.stringify({ origem: user }));
            log(`<i>Conectado como ${user}</i>`);
          },
          (err) => {
            log(`<span style="color:#c00">Erro de conexão: ${err}</span>`);
          }
        );
      }

      function disconnect() {
        if (stomp && connected) {
          const user = document.getElementById("username").value.trim();
          stomp.send("/app/chat.leave", {}, JSON.stringify({ origem: user }));
          stomp.disconnect(() => log(`<i>Desconectado</i>`));
          connected = false;
          document.getElementById("connectBtn").disabled = false;
          document.getElementById("disconnectBtn").disabled = true;
          document.getElementById("sendPublicBtn").disabled = true;
          document.getElementById("sendPrivateBtn").disabled = true;
          updateOnlineUsers([]); // limpa a lista de usuários
        }
      }

      function sendPublic() {
        const user = document.getElementById("username").value.trim();
        const texto = document.getElementById("message").value.trim();
        if (!texto) return;
        stomp.send(
          "/app/chat.send",
          {},
          JSON.stringify({ origem: user, texto: texto })
        );
        document.getElementById("message").value = "";
      }

      function sendPrivate() {
        const user = document.getElementById("username").value.trim();
        const texto = document.getElementById("private-message").value.trim();
        const destino = document.getElementById("user-select").value;

        if (!destino) {
            alert("Você precisa selecionar um usuário para enviar a mensagem.");
            return;
        }
        if (!texto) {
            alert("Você precisa digitar uma mensagem.");
            return;
        }

        // enviando para o mapping /app/chat.private
        stomp.send(
            "/app/chat.private",
            {},
            JSON.stringify({ origem: user, texto: texto, destino: destino })
        );
        document.getElementById("private-message").value = "";
      }

      document.getElementById("connectBtn").onclick = connect;
      document.getElementById("disconnectBtn").onclick = disconnect;
      document.getElementById("sendPublicBtn").onclick = sendPublic;
      document.getElementById("sendPrivateBtn").onclick = sendPrivate;
    </script>
  </body>
</html>
